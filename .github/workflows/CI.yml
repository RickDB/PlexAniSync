name: CI

on:
  push:
    branches: [ master ]
    # Publish semver tags as releases.
    tags: [ 'v*.*.*' ]
    paths-ignore:
      - '.github/**'
      - '.gitattributes'
      - '.gitignore'
      - '**/*.md'
      - 'LICENSE'
      - 'renovate.json'
  pull_request:
    branches: [ master ]
  workflow_dispatch:

concurrency:
  group: ${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: 3.9
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint pylint-exit pytest
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    - name: Setup flake8 annotations
      uses: rbialon/flake8-annotations@v1
    - name: Add pylint annotator
      uses: pr-annotators/pylint-pr-annotator@v0.0.1
    - name: Lint with flake8 and pylint
      run: |
        flake8 .
        pylint PlexAniSync.py TautulliSyncHelper.py ./plexanisync || pylint-exit --error-fail --warn-fail $?
    - run: pytest

  test-and-list-v2:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4.2.2

      - name: Install uv
        uses: astral-sh/setup-uv@v6.3.1
        with:
          version: 0.7.21

      - name: Install dependencies
        run: uv sync --python ${{ matrix.python-version }}

      # Note: pyright rules are linted on the pre-commit job.
      - name: lint
        run: uv run pylint PlexAniSync.py TautulliSyncHelper.py ./plexanisync || uv run pylint-exit --error-fail --warn-fail $?

      - name: test
        run: uv run pytest

  pre-commit:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4.2.2

      - name: Install uv
        uses: astral-sh/setup-uv@v6.3.1
        with:
          version: 0.7.21

      - name: Get current branch state to compare in pre-commit
        run: git fetch origin ${{ github.base_ref }}

      - name: Run pre-commit
        run: uv run pre-commit run --from-ref origin/${{ github.base_ref }} --to-ref HEAD --show-diff-on-failure

  build-docker-plexanisync:
    needs: lint-and-test
    uses: ./.github/workflows/build-docker-image.yml
    with:
      dockerfile: ./Docker/PlexAniSync/Dockerfile
      imagename: ${{ github.repository_owner }}/plexanisync
      eventname: ${{ github.event_name }}
      platforms: linux/amd64,linux/arm/v7,linux/arm64
    secrets: inherit

  build-docker-tautulli:
    needs: build-docker-plexanisync
    uses: ./.github/workflows/build-docker-image.yml
    with:
      dockerfile: ./Docker/Tautulli/Dockerfile
      imagename: ${{ github.repository_owner }}/tautulli-plexanisync
      eventname: ${{ github.event_name }}
      platforms: linux/amd64,linux/arm/v7,linux/arm64
    secrets: inherit
